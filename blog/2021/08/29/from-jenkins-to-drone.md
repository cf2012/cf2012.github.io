# ä»Jenkinsåˆ°Drone

## æˆ‘ä¸Jenkinsæˆ˜æ–—æ—¥å­

2014å¹´~2018å¹´æˆ‘åœ¨çš„å…¬å¸ä½¿ç”¨ä½¿ç”¨[Jenkins](https://www.jenkins.io/) ä¸ [rundeck]([http://rundeck.org](http://rundeck.org/))å®ç°CI/CD.   å‰æœŸä¸»åŠ›æ˜¯`Jenkins`.  ä½¿ç”¨`Jenkins`ç»å†äº†å‡ ä¸ªé˜¶æ®µ:

1. ä½¿ç”¨Web UIç‚¹ç‚¹. å¤æ‚çš„é€»è¾‘ç”¨`shell`è„šæœ¬å®ç°,ç”±`Jenkins`è°ƒç”¨
2. ä½¿ç”¨`Jenkins`çš„[pipeline](https://www.jenkins.io/doc/book/pipeline/)åŠŸèƒ½,é€šè¿‡[groovy](https://groovy-lang.org/)è„šæœ¬å°è£…å…¬å…±é€»è¾‘,å‡å°‘é‡å¤é…ç½®
3. CI/CDé˜¶æ®µ. å®ç°`git2jenkins`, ç”¨æˆ·å°†ä»£ç æ›´æ–°å,è§¦å‘è‡ªåŠ¨æ„å»º,å‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒ. éƒ¨ç½²åŒ…å­˜æ”¾åˆ°æŒ‡å®šç›®å½•. é€šè¿‡`rundeck`éƒ¨ç½²åœ¨çº¿ç¯å¢ƒ

### é˜¶æ®µ1. ä½¿ç”¨Jenkinsæ’ä»¶åŠ shellè„šæœ¬

æ•´ä¸ªç¼–è¯‘å‘å¸ƒè¿‡ç¨‹æœ‰ä»¥ä¸‹èŠ‚ç‚¹:

* èŠ‚ç‚¹1. ä»SCMä¸‹è½½æºç 
* èŠ‚ç‚¹2. ä»£ç ç¼–è¯‘
* èŠ‚ç‚¹3. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
* èŠ‚ç‚¹4. éƒ¨ç½²åˆ°åœ¨çº¿ç¯å¢ƒ
* èŠ‚ç‚¹5. å•å…ƒæµ‹è¯•
* èŠ‚ç‚¹6. `sonar`æ‰«æ

æ¯ä¸ªå­ç³»ç»Ÿä¸€èˆ¬åˆ†3æ¡æµæ°´çº¿:

| æµæ°´çº¿ | ä½œç”¨ | åŒ…å«çš„èŠ‚ç‚¹/å®ç°é€»è¾‘ | æƒé™æ§åˆ¶ | è¿è¡Œæ–¹å¼ | åˆ†æ”¯ | å¿…é€‰? |
| ------ | ---- | ------------------- | -------- | -------- | ------ | ------ |
| æµæ°´çº¿1 | å‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒ | èŠ‚ç‚¹1,2,3 | å¼€å‘äººå‘˜ã€ç»„é•¿ã€æµ‹è¯• | æ‰‹å·¥ | å¼€å‘åˆ†æ”¯ | Y |
| æµæ°´çº¿2 | å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ | èŠ‚ç‚¹1,2,4 | ç»„é•¿ã€æµ‹è¯•ã€è¿ç»´ | æ‰‹å·¥ | master | Y |
| æµæ°´çº¿3 | è´¨é‡æ§åˆ¶ | èŠ‚ç‚¹1, 5,6 | è¿ç»´ | æ¯å¤©å®šæ—¶è¿è¡Œ | Master | N |

### é˜¶æ®µ2. ä½¿ç”¨pipelineåŠŸèƒ½

**w h y** : åæ¥å…¬å¸å¼€å§‹åšå¤–éƒ¨é¡¹ç›®,éœ€è¦é…ç½®çš„ä¸œè¥¿å¤š.  æ­£å¥½æœ‰æ—¶é—´,æ‰€ä»¥å°±ç ”ç©¶äº†`pipeline`åŠŸèƒ½.

**how**: ä½¿ç”¨ `pipeline`å®ç°äº†:

- æ”¯æŒé€šè¿‡[shared-libraries](https://jenkins.io/doc/book/pipeline/shared-libraries/)å¤ç”¨ä»£ç 
- åœ¨SCMå·¥å…·ä¸­å¯ä»¥çœ‹åˆ°å†å²ç‰ˆæœ¬. æ–¹ä¾¿å›é€€.
- æ–¹ä¾¿åœ¨ä¸åŒé¡¹ç›®éƒ¨ç½²Jenkins

æœ€ç»ˆæ•ˆæœ:

```groovy

//file: dev_publish_web_bss.groovy. Jenkinsç›´æ¥è°ƒç”¨
@Library('my_tools') _

// å°è£…çš„å‡½æ•°. å°†ä¸‹è½½ã€ç¼–è¯‘ã€å‘å¸ƒå…¨å°è£…äº†. æ ¹æ®å…¥å‚é€‰ä¸åŒçš„é…ç½® 
// å°è£…äº†å‘é€é€šçŸ¥æ¨¡å—.å®ç°é€šè¿‡å®å®å‘é€é€šçŸ¥,å‘ŠçŸ¥å‘å¸ƒè¿›åº¦
projectxxWebDelivery(
	Job_Name: "web-bss", 
	Job_Desc: "å¼€å‘ç¯å¢ƒå‰ç«¯-bss",
	Deploy_To: "dev",
)

```

p.s. å¤ªå¤æ‚äº†.èµ°ç«å…¥é­”çš„æ„Ÿè§‰ ğŸ˜“

### é˜¶æ®µ3, CI&CD

**why**: å·æ‡’,ä¸æƒ³æ¯æ¬¡æ‰‹å·¥ç‚¹`jenkins`. å½“ç„¶è¿˜æ˜¯æœ‰æ—¶é—´. 

**how**: å®ç°åŠŸèƒ½æœ‰:

1. `git2jenkins`åŠŸèƒ½. ç”¨æˆ·æäº¤ä»£ç å¯ä»¥è§¦å‘`Jenkins`æ„å»º. è¿™æ ·æäº¤ä»£ç å°±ä¼šè‡ªåŠ¨åšå•å…ƒæµ‹è¯•,æˆåŠŸåå¯ä»¥å‘å¸ƒåˆ°CIç¯å¢ƒ
2. æ¯ä¸ªç‰ˆæœ¬æ„å»ºçš„ç»“æœä¿å­˜èµ·æ¥.`war`åŒ…æˆ–`docker image` .  å¹¶å°†ç‰ˆæœ¬å·è®°å½•åˆ°`DB` ä¸­
3. éƒ¨ç½²æ—¶,å¯ä»¥ä»`db`ä¸­é€‰æ‹©æŒ‡å®šçš„ç‰ˆæœ¬éƒ¨ç½². ä¸ç”¨å†é‡æ–°ç¼–è¯‘. é€šè¿‡`rundeck`æ“ä½œ

å…¶ä¸­`git2jenkins`åŠŸèƒ½å®ç°æµç¨‹:

1. `gitee`ä¸Šé…ç½®`webhook` æœ‰äºº`push`ä»£ç æ—¶,è°ƒç”¨`rundeck`. è§æˆ‘çš„é¡¹ç›®: [gitee2rundeck-adapter](https://github.com/cf2012/gitee2rundeck-adapter)
2. `rundeck` æ”¶åˆ°è¯·æ±‚æ—¶,æ ¹æ®é€»è¾‘è°ƒç”¨`jenkins`æ„å»º

p.s. ä½¿ç”¨`rundeck`ä¸­è½¬çš„åŸå› :  `rundeck`çš„æƒé™æ§åˆ¶åšçš„æ¯”è¾ƒå¥½





å‚è€ƒèµ„æ–™: 

[pipeline getting started](https://www.jenkins.io/doc/book/pipeline/getting-started/)

[Jenkins Best Practices - Practical Continuous Deployment in the Real World ](https://godaddy.github.io/2018/06/05/cicd-best-practices/)

[pipeline shared-libraries](https://jenkins.io/doc/book/pipeline/shared-libraries/)

## ä¸ºä»€ä¹ˆé€‰æ‹© Drone

(åŠ¨æœº)

## ç”¨Drone å¦‚ä½•è§£å†³ä¹‹å‰çš„é—®é¢˜

## Drone æ¶æ„

## å†™Droneæ’ä»¶

## ä½¿ç”¨Drone execç»ƒæ‰‹

## å‚è€ƒèµ„æ–™

Bç«™è§†é¢‘[ã€ç”¨ Drone æ”¹å–„åœ˜éšŠè‡ªå‹•åŒ–æ¸¬è©¦åŠéƒ¨ç½²æµç¨‹ã€‘å³æŸæ¯… (R2-Day1) MOPCON 2018](https://www.bilibili.com/video/BV1H741137Uy?from=search&seid=1300991805432371752)

